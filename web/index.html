<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuGet Gallery</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/3.0.1/mustache.min.js"
        integrity="sha256-srhz/t0GOrmVGZryG24MVDyFDYZpvUH2+dnJ8FbpGi0=" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        #package-info {
            grid-row: 2;
            grid-column: 2;
            overflow: auto;
            margin: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <input id="filter-input"></input>
            <button onclick="filter()">Filter</button>
        </div>
        <div class="packages-list">
            <div id="packages-list-items-container"></div>
        </div>
        <div id="package-info"></div>
    </div>

    <div class="templates">


    </div>
    </div>

    <script>
        let vscode = acquireVsCodeApi();
        let packages = [];
        let projects = [];
        let selected = null;

        let projectsToUpdate = [];

        function selectPackage(item, id) {
            projectsToUpdate = [];
            if (selected)
                selected.html.classList.remove("selected");

            if (item == null || id == null) {
                selected = null;
                document.getElementById("package-info").innerHTML = "";
            } else {
                let packageData = packages.data.filter(x => x.id == id)[0];
                let packageProjects = projects.map(p => ({
                    project: p.project,
                    path: p.path,
                    version: p.packages.filter(pck => pck.id == packageData.id).length > 0 ?
                        p.packages.filter(pck => pck.id == packageData.id)[0].version : null
                }));
                selected = {
                    html: item,
                    data: packageData,
                    projects: packageProjects
                }
                selected.html.classList.add("selected");

                reloadProjectsTemplate();
            }
        }

        function reloadProjectsTemplate() {
            let template = document.getElementById("package-info-template").innerHTML;
            let result = Mustache.render(template, selected);
            document.getElementById("package-info").innerHTML = result;
        }





        function projectSelectionChanged(ev, project) {
            if (ev.target.checked === true)
                projectsToUpdate.push(project);
            else
                projectsToUpdate = projectsToUpdate.filter(x => x !== project);
        }

        function refreshProjects() {
            if (selected) {
                selected.projects = null;
                reloadProjectsTemplate();
            }
            vscode.postMessage({
                command: 'reloadProjects',
            })
        }

        function install() {
            vscode.postMessage({
                command: 'add',
                projects: projectsToUpdate.map(x => projects.find(p => p.project == x)),
                package: selected.data,
                version: document.getElementById('package-version-selector').value
            })
        }

        function uninstall() {
            vscode.postMessage({
                command: 'remove',
                projects: projectsToUpdate.map(x => projects.find(p => p.project == x)),
                package: selected.data
            })
        }

        filter();
        refreshProjects();
    </script>
</body>

</html>